<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Equity Intel</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Inter, sans-serif; background:#f8fafc; padding:40px }
.container { max-width:1000px; margin:auto; background:white; padding:30px; border-radius:14px }
input { width:100%; padding:14px; font-size:16px }
.results { border:1px solid #e5e7eb; margin-top:6px; display:none }
.item { padding:10px; cursor:pointer }
.item:hover { background:#eef2ff }
.chart-box { margin-top:30px }
</style>
</head>

<body>
<div class="container">
<h1>Equity Intel</h1>

<input id="search" placeholder="Search company..." onkeyup="doSearch()">
<div id="results" class="results"></div>

<h3 id="status">Ready</h3>

<div class="chart-box">
<canvas id="mainChart"></canvas>
</div>

<div class="chart-box">
<h2>üèõ Government Contracts</h2>
<canvas id="govChart"></canvas>
</div>
</div>

<script>
let mainChart, govChart;

async function doSearch() {
    const q = search.value;
    if (q.length < 2) return results.style.display = "none";

    const r = await fetch(`/search?q=${q}`);
    const data = await r.json();
    results.innerHTML = "";
    results.style.display = "block";

    data.forEach(s => {
        const d = document.createElement("div");
        d.className = "item";
        d.innerHTML = `<b>${s.ticker}</b> ‚Äì ${s.name}`;
        d.onclick = () => load(s);
        results.appendChild(d);
    });
}

async function load(s) {
    results.style.display = "none";
    status.innerText = "Loading " + s.ticker;

    const r = await fetch(`/get_financials?ticker=${s.ticker}&cik=${s.cik}&name=${encodeURIComponent(s.name)}`);
    const data = await r.json();
    if (data.error) return status.innerText = data.error;

    // ---- Market Cap Chart ----
    if (mainChart) mainChart.destroy();
    mainChart = new Chart(mainChartCtx = document.getElementById("mainChart"), {
        data: {
            labels: data.labels,
            datasets: [
                {
                    type: "bar",
                    label: "Market Cap",
                    data: data.market_cap,
                    backgroundColor: "rgba(59,130,246,.6)"
                },
                {
                    type: "line",
                    label: "Shares Outstanding",
                    data: data.shares,
                    borderColor: "#10b981",
                    yAxisID: "y1"
                }
            ]
        },
        options: {
            scales: {
                y: { ticks:{callback:v=>"$"+(v/1e9).toFixed(1)+"B"} },
                y1:{ position:"right", grid:{display:false} }
            }
        }
    });

    // ---- Government Contracts ----
    if (govChart) govChart.destroy();
    const agencyTotals = {};
    data.gov_contracts.forEach(c=>{
        agencyTotals[c.agency]=(agencyTotals[c.agency]||0)+c.amount;
    });

    govChart = new Chart(document.getElementById("govChart"),{
        type:"bar",
        data:{
            labels:Object.keys(agencyTotals),
            datasets:[{
                label:`Gov Contracts (${data.ticker})`,
                data:Object.values(agencyTotals),
                backgroundColor:"#f59e0b"
            }]
        },
        options:{
            scales:{ y:{ ticks:{callback:v=>"$"+(v/1e6).toFixed(1)+"M"} } }
        }
    });

    status.innerHTML = `<strong>Showing ${data.ticker} ‚Äî ${data.company}</strong>`;

    status.innerHTML = `
<strong>Showing ${data.ticker} ‚Äî ${data.company}</strong>
&nbsp;|&nbsp;
<a href="/contracts?ticker=${data.ticker}&company=${encodeURIComponent(data.company)}"
   target="_blank"
   style="color:#2563eb; font-weight:600; text-decoration:none;">
   View all government contracts ‚Üí
</a>
`;


}
</script>
</body>
</html>
